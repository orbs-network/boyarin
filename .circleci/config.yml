version: 2.1
jobs:
  test:
    docker:
      - image: circleci/golang:1.12
    environment: # environment variables for the build itself
      TEST_RESULTS: /tmp/test-results # path to where test results will be saved
    steps:
      - checkout # check out source code to working directory
      - run: mkdir -p $TEST_RESULTS # create the test results directory

      - restore_cache: # restores saved cache if no changes are detected since last run
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}

      - run:
          name: Run unit tests
          # store the results of our tests in the $TEST_RESULTS directory
          command: |
            PACKAGE_NAMES=$(go list ./... | circleci tests split --split-by=timings --timings-type=classname)
            gotestsum --junitfile ${TEST_RESULTS}/gotestsum-report.xml -- $PACKAGE_NAMES

      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"

      - store_test_results: # upload test results for display in Test Summary
          path: /tmp/test-results

  dev-build:
    docker:
      - image: itamararjuan/golang_with_node_aws
    steps:
      - checkout
      - run: ./.circleci/set-aws-credentials.sh
      - run: ./build-to-s3.sh

  test-e2e:
    machine: true
    environment:
      TEST_RESULTS: /tmp/test-results # path to where test results will be saved
    steps:
      - checkout
      - run: mkdir -p $TEST_RESULTS # create the test results directory
      - run: .circleci/setup-machine.sh
      - docker/install-docker
      - run: |
          cat $BASH_ENV
          go version
          node --version
          env
          go env
          docker --version
      - run: ./.circleci/setup-e2e.sh
      - run:
          name: spinning up ganache
          command: npm install -g ganache-cli && ganache-cli -m 'pet talent sugar must audit chief biology trash change wheat educate bone' -h 0.0.0.0  -i 5777 -p 7545
          background: true
      - run: go mod download && go mod verify
      - run:
          name: run tests
          environment:
            ENABLE_ETHEREUM: "true"
            ETHEREUM_PRIVATE_KEY: 7a16631b19e5a7d121f13c3ece279c10c996ff14d8bebe609bf1eca41211b291
            ETHEREUM_ENDPOINT: http://127.0.0.1:7545
            ENABLE_SWARM: "true"
          command: |
            export LOCAL_IP=$(python -c "import socket; print socket.gethostbyname(socket.gethostname())")
            PACKAGE_NAMES=$(go list ./... | circleci tests split --split-by=timings --timings-type=classname)
            gotestsum --junitfile ${TEST_RESULTS}/gotestsum-report.xml -- -timeout 30m -p 1 $PACKAGE_NAMES
          no_output_timeout: 1h
      - store_test_results: # Upload test results for display in Test Summary: https://circleci.com/docs/2.0/collect-test-data/
          path: /tmp/test-results
orbs:
  docker: circleci/docker@0.5.19

workflows:
  version: 2
  build:
    jobs:
      - test
      - test-e2e
      - dev-build:
          requires:
            - test
            - test-e2e
